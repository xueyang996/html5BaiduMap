<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>浏览器定位</title>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.1&key=7f557d5a3ac85ac7074a5ca30cffb935"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <script src="http://g.alicdn.com/dingding/open-develop/1.9.0/dingtalk.js"></script>
    <script src="https://cdn.bootcss.com/zepto/1.0rc1/zepto.min.js"></script>
    <script src="//cdn.bootcss.com/eruda/1.2.4/eruda.min.js"></script>
    <script>eruda.init()</script>

    <body>
        <div id='container'></div>
        <div id="tip"></div>
        <div class="button-group">
            <input type="button" class="button" value="清空轨迹" id="stopRecord">
        </div>
        <script type="text/javascript">
            var map, geolocation, positionArray = [];
            // 加载地图，调用浏览器定位服务
            map = new AMap.Map('container', {
                resizeEnable: true
            });
            map.plugin('AMap.Geolocation', function() {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true, //是否使用高精度定位，默认:true
                    timeout: 10000, //超过10秒后停止定位，默认：无穷大
                    buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                    zoomToAccuracy: true, //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                    buttonPosition: 'RB'
                });
                map.addControl(geolocation);
                // geolocation.getCurrentPosition();
                // AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
                // AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
            });
            // setInterval(function() {
            //     geolocation.getCurrentPosition();
            // }, 10000);
            //解析定位结果
            // function onComplete(data) {
            //     positionArray.push([data.position.getLng(), data.position.getLat()]);
            //     drawLine(positionArray.slice(-2));
            // }
            // //解析定位错误信息
            // function onError(data) {
            //     document.getElementById('tip').innerHTML = '定位失败';
            // }

            function drawLine(lineArr) {
                if (lineArr.length > 1) {
                    console.log("centerset")
                    var polyline = new AMap.Polyline({
                        path: lineArr, //设置线覆盖物路径
                        strokeColor: "#3366FF", //线颜色
                        strokeOpacity: 1, //线透明度
                        strokeWeight: 5, //线宽
                        strokeStyle: "solid", //线样式
                        strokeDasharray: [10, 5] //补充线样式
                    });
                    polyline.setMap(map);

                    map.setCenter(new AMap.LngLat(lineArr[1][0], lineArr[1][1]));
                }
            }

            /**
             * [ajaxQuery ajax请求]
             * @param  {Function} callback [请求成功时回调函数]
             * @param  {string}   url      [请求url]
             * @param  {string}   data      [请求参数]
             * @param  {string}   type      [请求类型，默认为get]
             */
            function ajaxQuery(callback, url, data, type) {
                var dataInput = data || {},
                    typeInput = type || 'GET';

                if (typeInput.toLowerCase() === 'post') {
                    dataInput = JSON.stringify(dataInput);
                }

                $.ajax({
                    url: url,
                    type: typeInput,
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    data: dataInput,
                    success: function(data) {
                        callback(data);
                    },
                    error: function() {
                        alert('出错了');
                    }
                });
            }
            function stopGPS() {
                dd.device.geolocation.stop({
                    sceneId: 'yingyan', // 需要停止定位场景id
                    onSuccess: function(result) {
                        console.log(result);
                    },
                    onFail: function(err) {}
                });
            }
            function callback(_config) {
                console.log(_config.corpId, _config.signature, _config, typeof _config)
                dd.config({
                    agentId: '136185737',
                    corpId: _config.corpId,
                    timeStamp: _config.timeStamp,
                    nonceStr: _config.nonceStr,
                    signature: _config.signature,
                    jsApiList: ['device.geolocation.start', 'device.geolocation.stop']
                });


                dd.ready(function() {
                    alert('okok!!!!');
                    stopGPS();
                    dd.device.geolocation.start({
                        targetAccuracy: 10, // 期望精确度
                        iOSDistanceFilter: 10, // 变更感知精度(iOS端参数)
                        useCache: false, // 是否使用缓存(Android端参数)
                        withRegeocode: false, // 是否返回逆地理信息,默认否
                        callBackInterval: 10000, //回传时间间隔，ms
                        sceneId: 'yingyan', // 定位场景id,
                        onSuccess: function(result) {
                            console.log(JSON.stringify(result), 'hhh')
                            console.log(result.longitude, typeof result.longitude)
                            positionArray.push([result.longitude, result.latitude]);
                            drawLine(positionArray.slice(-2));
                        },
                        onFail: function(err) {
                            console.log(JSON.stringify(err))
                        }
                    });
                });
                $('#stopRecord').on('click', stopGPS);

                dd.error(function(err) {
                    alert('dd error: ' + JSON.stringify(err));
                });
            }
            ajaxQuery(callback, 'http://192.168.31.19:8080/dingdinglogin/getSign?type=yingyan');
        </script>
    </body>

</html>
